/* Find patients who are in services with above-average staff count.*/
  SELECT *
FROM patients
WHERE service IN (
    SELECT service
    FROM staff
    GROUP BY service
    HAVING COUNT(*) > (
        SELECT AVG(staff_count)
        FROM (
            SELECT service, COUNT(*) AS staff_count
            FROM staff
            GROUP BY service
        ) AS t
    )
);

/* List staff who work in services that had any week with patient satisfaction below 70.*/

	SELECT *
FROM staff s
WHERE EXISTS (
    SELECT 1
    FROM services_weekly sw
    WHERE sw.service = s.service
    AND sw.patient_satisfaction < 70
);

/* Show patients from services where total admitted patients exceed 1000.*/
	SELECT *
FROM patients
WHERE service IN (
    SELECT service
    FROM services_weekly
    GROUP BY service
    HAVING SUM(patients_admitted) > 1000
);

### Today's Challenge:

/*Question: Find all patients who were admitted to services that had at least one week where patients were refused AND the average patient satisfaction for that service was 
below the overall hospital average satisfaction. Show patient_id, name, service, and their personal satisfaction score.*/
		SELECT 
    patient_id, 
    name, 
    service, 
    satisfaction
FROM patients p
WHERE service IN (
    -- Services with refusals
    SELECT DISTINCT service
    FROM services_weekly
    WHERE patients_refused > 0
)
AND service IN (
    -- Services with below-average satisfaction
    SELECT service
    FROM services_weekly
    GROUP BY service
    HAVING AVG(patient_satisfaction) < (
        SELECT AVG(patient_satisfaction)
        FROM services_weekly
    )
);
